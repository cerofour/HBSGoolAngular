<section class="p-6">
  <app-breadcrumbs></app-breadcrumbs>

  <header class="mb-6 flex justify-between items-start">
    <div>
      <h1 class="text-2xl font-semibold text-gray-800">Listado de Reservaciones</h1>
      <p class="text-gray-500 text-sm">
        Consulta el historial de reservaciones.
      </p>
    </div>
    <div class="flex gap-2">
      <app-button [variant]="viewMode === 'table' ? 'primary' : 'neutral'" (click)="setViewMode('table')" type="button">
        <i class="ph ph-table"></i>
      </app-button>
      <app-button [variant]="viewMode === 'cards' ? 'primary' : 'neutral'" (click)="setViewMode('cards')" type="button">
        <i class="ph ph-squares-four"></i>
      </app-button>
    </div>
  </header>

  <div class="mb-6 flex flex-col gap-4 sm:flex-row sm:items-end">
    <label class="flex flex-col gap-1 text-sm text-gray-700">
      Usuario ID
      <input type="number" [(ngModel)]="usuarioId" placeholder="ID Usuario"
        class="rounded-md border border-gray-200 px-3 py-2 text-sm shadow-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20" />
    </label>

    <label class="flex flex-col gap-1 text-sm text-gray-700">
      Cancha ID
      <input type="number" [(ngModel)]="canchaId" placeholder="ID Cancha"
        class="rounded-md border border-gray-200 px-3 py-2 text-sm shadow-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20" />
    </label>

    <label class="flex flex-col gap-1 text-sm text-gray-700">
      DNI
      <input type="text" [(ngModel)]="dni" placeholder="DNI"
        class="rounded-md border border-gray-200 px-3 py-2 text-sm shadow-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20" />
    </label>

    <label class="flex flex-col gap-1 text-sm text-gray-700">
      Estado
      <select [(ngModel)]="estado"
        class="rounded-md border border-gray-200 px-3 py-2 text-sm shadow-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20">
        <option value="">Todos</option>
        <option value="CONFIRMADA">Confirmada</option>
        <option value="POR CONFIRMAR">Por confirmar</option>
        <option value="SALDO">Saldo</option>
        <option value="CANCELADA">Cancelada</option>
        <option value="FINALIZADA">Finalizada</option>
      </select>
    </label>

    <app-button [variant]="cargando ? 'disabled' : 'primary'" (click)="filtrar()">
      Filtrar
    </app-button>
  </div>

  @if (errorMsg) {
  <div class="mb-4 rounded-md border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
    {{ errorMsg }}
  </div>
  }

  @if (cargando) {
  <p class="text-gray-600">Cargando información...</p>
  } @else if (!cargando && reservations.length === 0) {
    <p class="text-gray-600">No hay información para mostrar.</p>
  } @else {
  @if (viewMode === 'table') {
  <div class="overflow-x-auto rounded-lg border border-gray-200">
    <app-table>
      <ng-container table-header>
        <tr>
          <th class="px-4 py-3 font-medium">CANCHA</th>
          <th class="px-4 py-3 font-medium">INICIO</th>
          <th class="px-4 py-3 font-medium">DURACION</th>
          <th class="px-4 py-3 font-medium">CAJERO</th>
          <th class="px-4 py-3 font-medium">DNI</th>
          <th class="px-4 py-3 font-medium">TOTAL</th>
          <th class="px-4 py-3 font-medium">SALDO</th>
          <th class="px-4 py-3 font-medium">ESTADO</th>
          <th class="px-4 py-3 font-medium">PAGOS</th>
          <th class="px-4 py-3 font-medium">ACCIONES</th>
        </tr>
      </ng-container>

      <ng-container table-body>
        @for (reservation of reservations; track reservation.idReservacion) {
        <tr class="transition hover:bg-gray-50">
          <td class="px-4 py-3">{{ reservation.canchaId }} </td>
          <td class="px-4 py-3">{{ reservation.tiempoInicio | date: 'short' }}</td>
          <td class="px-4 py-3">{{ getFormattedDuration(reservation.duracion) }}</td>
          <td class="px-4 py-3">
            <a class="text-primary underline decoration-transparent transition hover:decoration-primary"
              [routerLink]="['/admin', 'cajero', 'resumen', reservation.cajero?.idCajero]">
              {{ reservation.cajero?.nombreCompleto }}
            </a>
          </td>
          <td class="px-4 py-3">

            @if (reservation.usuarioId) {
            <a class="text-primary underline decoration-transparent transition hover:decoration-primary text-sm"
              [routerLink]="['/admin', 'usuario', reservation.usuarioId]">
              {{ reservation.dni }}
            </a>
            } @else {
            {{ reservation.dni }}
            }
          </td>
          <td class="px-4 py-3 font-semibold text-gray-900">
            {{ reservation.precioTotal }}
          </td>
          <td class="px-4 py-3 font-semibold text-gray-900">
            {{ reservation.saldo }}
          </td>
          <td class="px-4 py-3">
            <span [class]="getEstadoClass(reservation.estadoReservacion)">
              {{ reservation.estadoReservacion }}
            </span>
          </td>
          <td class="px-4 py-3">
            @for (pago of reservation.pagos; track $index) {
            <a class="text-primary underline decoration-transparent transition hover:decoration-primary"
              [routerLink]="['/admin/pago', pago]">
              #{{ pago }}{{ ' ' }}
            </a>
            }
          </td>
          <td class="px-4 py-3">
            <div class="flex gap-2">
            <app-button-link [routerLink]="[reservation.idReservacion]" variant="secondary"><i class="ph ph-file-text"></i></app-button-link>
            @if (reservation.estadoReservacion === 'SALDO') {
            <app-button type="button" title="Completar Pago" (click)="openCompletePaymentModal(reservation)">
              <i class="ph ph-hand-coins"></i>
            </app-button>
          }
            </div>
            </td>
        </tr>
        }
      </ng-container>
    </app-table>
  </div>
  } @else {
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    @for (reservation of reservations; track reservation.idReservacion) {
    <app-reservation-card-admin [reservation]="reservation" (completePayment)="openCompletePaymentModal($event)">
    </app-reservation-card-admin>
    }
  </div>
  }
  }
  <div class="mt-4 flex justify-end">
    <app-pagination [totalItems]="totalElements" [pageSize]="pageSize" [currentPage]="page" [totalPages]="totalPages"
      (pageChange)="onPageChange($event)"></app-pagination>
  </div>

  <app-modal #completePaymentModal title="Completar pago">
    @if (selectedReservation) {
    <form #completePaymentForm="ngForm" (ngSubmit)="submitCompletePayment(completePaymentForm)" class="space-y-4">
      <div class="flex items-center justify-between border-b border-gray-200 pb-2">
        <div>
          <p class="text-sm text-gray-500">Reservación</p>
          <p class="text-lg font-semibold text-gray-900">#{{ selectedReservation.idReservacion }}</p>
        </div>
        <div class="text-right text-sm text-gray-600">
          Saldo pendiente:
          <span class="font-semibold text-gray-900">{{ selectedReservation.saldo }}</span>
        </div>
      </div>

      <label class="flex flex-col gap-1 text-sm text-gray-700">
        Cantidad a pagar *
        <input type="number" name="cantidadDinero" [(ngModel)]="paymentForm.cantidadDinero" min="0" step="0.1" required
          class="rounded-md border border-gray-200 px-3 py-2 text-sm shadow-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20" />
      </label>

      <label class="flex flex-col gap-1 text-sm text-gray-700">
        Medio de pago *
        <select name="medioPago" [(ngModel)]="paymentForm.medioPago" required (ngModelChange)="onMedioPagoChange()"
          class="rounded-md border border-gray-200 px-3 py-2 text-sm shadow-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20">
          <option value="">Seleccionar</option>
          <option value="REMOTO">REMOTO</option>
          <option value="EFECTIVO">EFECTIVO</option>
        </select>
      </label>

      @if (shouldRequestEvidence()) {
      <label class="flex flex-col gap-1 text-sm text-gray-700">
        Evidencia *
        <input type="file" (change)="onEvidenceChange($event)" accept="image/*"
          class="rounded-md border border-gray-200 px-3 py-2 text-sm shadow-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20" />
      </label>
      }

      @if (completePaymentError) {
      <p class="text-sm text-red-600">{{ completePaymentError }}</p>
      }

      <div class="flex justify-end gap-2 pt-2">
        <app-button type="button" variant="neutral" (click)="closeCompletePaymentModal()">Cancelar</app-button>
        <app-button type="submit" [variant]="completePaymentLoading ? 'disabled' : 'primary'">
          {{ completePaymentLoading ? 'Procesando...' : 'Confirmar' }}
        </app-button>
      </div>
    </form>
    }
  </app-modal>
</section>