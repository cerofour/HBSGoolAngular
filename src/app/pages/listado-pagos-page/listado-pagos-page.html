<div class="p-4">
  <h1 class="text-2xl font-semibold text-gray-800 mb-4">Listado de Pagos</h1>

  @if (loading) {
    <p class="text-gray-600">Cargando pagos...</p>
  } @else if (error) {
    <p class="text-red-600">{{ error }}</p>
  } @else if (pagos.length === 0) {
    <p class="text-gray-600">No hay pagos para mostrar.</p>
  } @else {
    <app-table>
      <ng-container table-header>
        <tr>
          <th class="px-4 py-3 font-medium">ID</th>
          <th class="px-4 py-3 font-medium">Reservación</th>
          <th class="px-4 py-3 font-medium">Sesión Cajero</th>
          <th class="px-4 py-3 font-medium">Cantidad</th>
          <th class="px-4 py-3 font-medium">Fecha</th>
          <th class="px-4 py-3 font-medium">Medio</th>
          <th class="px-4 py-3 font-medium">Estado</th>
          <th class="px-4 py-3 font-medium">Evidencia</th>
        </tr>
      </ng-container>
      <ng-container table-body>
        @for (pago of pagos; track pago.idPago) {
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3">{{ pago.idPago }}</td>
            <td class="px-4 py-3">{{ pago.reservacionId ?? '-' }}</td>
            <td class="px-4 py-3">{{ pago.sesionCajeroId ?? '-' }}</td>
            <td class="px-4 py-3">S/. {{ pago.cantidadDinero }}</td>
            <td class="px-4 py-3">{{ pago.fecha | date:'short' }}</td>
            <td class="px-4 py-3">{{ pago.medioPago }}</td>
            <td class="px-4 py-3">
              @if (pago.estadoPago === 'CONFIRMADO') {
                <span class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-medium bg-green-100 text-green-800">
                  <span class="h-2 w-2 rounded-full bg-green-500"></span>
                  Confirmado
                </span>
              } @else {
                <button class="text-primary underline decoration-transparent hover:decoration-primary" (click)="openReview(pago)">Revisar</button>
              }
            </td>
            <td class="px-4 py-3 text-primary">
              @if (pago.evidencia) {
                <a class="underline decoration-transparent hover:decoration-primary" target="_blank" [href]="pago.evidencia">Ver</a>
              } @else {
                <span class="text-gray-400">—</span>
              }
            </td>
          </tr>
        }
      </ng-container>
    </app-table>

    <div class="mt-4 flex justify-end">
      <app-pagination
        [totalItems]="totalElements"
        [pageSize]="pageSize"
        [currentPage]="page"
        (pageChange)="onPageChange($event)"
      ></app-pagination>
    </div>

    <app-modal #reviewModal title="Revisar Pago">
      @if (selectedPago) {
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="text-gray-500">DNI</div>
            <div class="font-medium">{{ selectedReserva?.dni ?? '-' }}</div>
            <div class="text-gray-500">Hora de inicio</div>
            <div class="font-medium">{{ selectedReserva?.tiempoInicio | date:'short' }}</div>
            <div class="text-gray-500">Cantidad pagada</div>
            <div class="font-medium">S/. {{ selectedPago.cantidadDinero }}</div>
          </div>

          <div class="mt-2">
            <div class="text-sm text-gray-500 mb-1">Evidencia</div>
            @if (loadingReview) {
              <p class="text-gray-500 text-sm">Cargando evidencia...</p>
            } @else if (evidenciaUrl) {
              <img [src]="evidenciaUrl" alt="Evidencia de pago" class="max-h-80 rounded border" />
            } @else {
              <p class="text-gray-400 text-sm">Sin evidencia</p>
            }
          </div>

          <div class="flex justify-end gap-2 pt-2">
            <app-button variant="danger" (click)="rechazarPago()">Rechazar</app-button>
            <app-button variant="primary" (click)="confirmarPago()">Confirmar</app-button>
          </div>
        </div>
      }
    </app-modal>
  }
</div>
